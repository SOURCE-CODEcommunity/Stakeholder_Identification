<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SHIS</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Your existing CSS remains the same */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
    }

    body {
      background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      color: #333;
    }

    .container {
      width: 100%;
      max-width: 500px;
      background: white;
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      animation: fadeIn 0.6s ease-out;
      transition: transform 0.3s ease;
    }

    .container:hover {
      transform: translateY(-5px);
    }

    .header {
      background: linear-gradient(135deg, #86b4ff 0%, #505f54  100%);
      color: white;
      padding: 30px 20px;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .header::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 70%);
      animation: pulse 8s infinite linear;
    }

    .logo {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 15px;
    }

    .logo-icon {
      font-size: 150px, 24px;
      margin-right: 10px;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
    }

    h1 {
      font-size: 24px;
      font-weight: 500;
      margin-bottom: 8px;
      position: relative;
    }

    .subtitle {
      font-size: 14px;
      opacity: 0.9;
      font-weight: 300;
    }

    .content {
      padding: 30px;
    }

    .upload-area {
      border: 2px dashed #dadce0;
      border-radius: 12px;
      padding: 40px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-bottom: 25px;
      position: relative;
      background: #f8f9fa;
    }

    .upload-area:hover, .upload-area.active {
      border-color: #4285f4;
      background: #f0f7ff;
    }

    .upload-icon {
      font-size: 48px;
      color: #619eff;
      margin-bottom: 15px;
      transition: transform 0.3s ease;
    }

    .upload-area:hover .upload-icon {
      transform: scale(1.1);
    }

    .upload-text {
      font-size: 16px;
      margin-bottom: 10px;
    }

    .browse-text {
      color: #619eff;
      font-weight: 500;
    }

    .file-info {
      display: none;
      margin-top: 15px;
      padding: 12px;
      background: #e8f0fe;
      border-radius: 8px;
      text-align: left;
    }

    .file-name {
      font-weight: 500;
      margin-bottom: 5px;
      display: flex;
      align-items: center;
    }

    .file-name i {
      margin-right: 8px;
      color: #4285f4;
    }

    .file-size {
      font-size: 13px;
      color: #5f6368;
    }

    .upload-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #86b4ff 0%, #505f54 100%);
      color: white;
      border: solid rgba(237, 237, 255, 0.034) 1.2px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
    }

    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(66, 133, 244, 0.4);
    }

    .upload-btn:active {
      transform: translateY(0);
    }

    .upload-btn i {
      margin-right: 8px;
    }

    .response {
      margin-top: 25px;
      padding: 20px;
      border-radius: 12px;
      background: #f8f9fa;
      display: none;
      animation: slideDown 0.5s ease-out;
      border-left: 4px solid #4285f4;
    }

    .response.success {
      border-left-color: #34a853;
      background: #f0f8f0;
    }

    .response.error {
      border-left-color: #ea4335;
      background: #fef0f0;
    }

    .response-title {
      font-weight: 500;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }

    .response-title i {
      margin-right: 8px;
    }

    .response-details {
      font-size: 14px;
      line-height: 1.5;
    }

    .preview-text {
      margin-top: 10px;
      padding: 10px;
      background: white;
      border-radius: 6px;
      font-size: 13px;
      color: #5f6368;
      border: 1px solid #e8e8e8;
      word-wrap: break-word;
    }

    .loading {
      display: none;
      text-align: center;
      margin: 20px 0;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(66, 133, 244, 0.2);
      border-left: 4px solid #4285f4;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    .loading-text {
      font-size: 14px;
      color: #5f6368;
    }

    .download-btn {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #ea4335 0%, #fbbc05 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0 4px 12px rgba(234, 67, 53, 0.3);
      margin-top: 15px;
    }

    .download-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(234, 67, 53, 0.4);
    }

    .download-btn:active {
      transform: translateY(0);
    }

    .download-btn i {
      margin-right: 8px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0% { transform: translate(0, 0) rotate(0deg); }
      100% { transform: translate(0, 0) rotate(360deg); }
    }

    .footer {
      text-align: center;
      padding: 20px;
      font-size: 12px;
      color: #5f6368;
      border-top: 1px solid #e8e8e8;
      background: #f8f9fa;
    }

    @media (max-width: 600px) {
      .container {
        max-width: 100%;
      }
      
      .content {
        padding: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <i class="fas fa-users"></i>
      </div>
      <h1>Stakeholder Identification System</h1>
      <p class="subtitle">Upload your PDF for intelligent analysis</p>
    </div>
    
    <div class="content">
      <div class="upload-area" id="uploadArea">
        <i class="fas fa-cloud-upload-alt upload-icon"></i>
        <p class="upload-text">Drag & drop your PDF here</p>
        <p>or <span class="browse-text">browse files</span></p>
        
        <div class="file-info" id="fileInfo">
          <div class="file-name">
            <i class="fas fa-file-pdf"></i>
            <span id="fileName">document.pdf</span>
          </div>
          <div class="file-size" id="fileSize">0 KB</div>
        </div>
      </div>
      
      <input type="file" id="pdfFile" accept=".pdf" hidden>
      
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p class="loading-text">Processing your document...</p>
      </div>
      
      <button class="upload-btn" id="uploadBtn">
        <i class="fas fa-upload"></i> Analyze PDF
      </button>
      
      <div class="response" id="responseBox">
        <div class="response-title">
          <i class="fas fa-check-circle"></i>
          <span>Analysis Complete</span>
        </div>
        <div class="response-details" id="responseDetails">
          <!-- Response content will be inserted here -->
        </div>
      </div>

      <button class="download-btn" id="downloadBtn" style="display: none;">
        <i class="fas fa-download"></i> Download PDF
      </button>
    </div>
    
    <div class="footer">
      <p>@SHIS2025 • Secure & Private • AI-Powered Analysis • Supports PDF files up to 10MB</p>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('pdfFile');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const uploadBtn = document.getElementById('uploadBtn');
    const responseBox = document.getElementById('responseBox');
    const responseDetails = document.getElementById('responseDetails');
    const loading = document.getElementById('loading');
    const downloadBtn = document.getElementById('downloadBtn');

    // Retry configuration
    const RETRY_CONFIG = {
      maxRetries: 3,
      initialDelay: 1000, // 1 second
      maxDelay: 10000, // 10 seconds
      backoffMultiplier: 2
    };

    let currentRetryCount = 0;
    let currentFile = null;

    // Click on upload area to trigger file input
    uploadArea.addEventListener('click', () => {
      fileInput.click();
    });

    // Drag and drop functionality
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('active');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('active');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('active');
      
      if (e.dataTransfer.files.length) {
        fileInput.files = e.dataTransfer.files;
        handleFileSelection();
      }
    });

    // File input change event
    fileInput.addEventListener('change', handleFileSelection);

    function handleFileSelection() {
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        
        // Validate file type
        if (file.type !== 'application/pdf') {
          showResponse('Please select a valid PDF file', false);
          resetFileInput();
          return;
        }
        
        // Validate file size (10MB limit)
        if (file.size > 10 * 1024 * 1024) {
          showResponse('File size must be less than 10MB', false);
          resetFileInput();
          return;
        }
        
        // Display file info
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.style.display = 'block';
        
        // Enable upload button
        uploadBtn.disabled = false;
        currentFile = file;
      }
    }

    // Upload button click event
    uploadBtn.addEventListener('click', handleUpload);

    async function handleUpload() {
      if (!fileInput.files.length) {
        showResponse('Please select a PDF file first', false);
        return;
      }

      const file = fileInput.files[0];
      currentFile = file;
      currentRetryCount = 0;
      
      // Show loading state
      loading.style.display = 'block';
      responseBox.style.display = 'none';
      downloadBtn.style.display = 'none';
      uploadBtn.disabled = true;
      
      try {
        await uploadWithRetry(file);
      } catch (error) {
        console.error('Final upload error:', error);
        showResponse(getUserFriendlyErrorMessage(error), false);
      } finally {
        loading.style.display = 'none';
      }
    }

    async function uploadWithRetry(file, delay = RETRY_CONFIG.initialDelay) {
      try {
        const formData = new FormData();
        formData.append('file', file);
        
        const response = await fetchWithTimeout('https://stakeholder-identification.onrender.com/upload', {
          method: 'POST',
          body: formData,
          timeout: 30000 // 30 seconds timeout
        });

        if (!response.ok) {
          throw new Error(`Server responded with status: ${response.status}`);
        }

        const data = await response.json();
        console.log('API Response:', data);
        showSuccessResponse(data);
        currentRetryCount = 0; // Reset retry count on success
        
      } catch (error) {
        currentRetryCount++;
        
        if (currentRetryCount < RETRY_CONFIG.maxRetries) {
          const nextDelay = Math.min(delay * RETRY_CONFIG.backoffMultiplier, RETRY_CONFIG.maxDelay);
          
          // Show retry message
          showRetryMessage(currentRetryCount, nextDelay, error);
          
          // Wait and retry
          await new Promise(resolve => setTimeout(resolve, nextDelay));
          return uploadWithRetry(file, nextDelay);
        } else {
          throw error; // Max retries reached
        }
      }
    }

    function fetchWithTimeout(url, options = {}) {
      const { timeout = 30000, ...fetchOptions } = options;
      
      return new Promise((resolve, reject) => {
        const timer = setTimeout(() => {
          reject(new Error('Request timeout - server is taking too long to respond'));
        }, timeout);

        fetch(url, fetchOptions)
          .then(response => {
            clearTimeout(timer);
            resolve(response);
          })
          .catch(error => {
            clearTimeout(timer);
            reject(error);
          });
      });
    }

    function showRetryMessage(retryCount, delay, error) {
      const retryMessage = `
        <div style="text-align: center; padding: 10px;">
          <i class="fas fa-sync-alt" style="color: #fbbc05; font-size: 24px; margin-bottom: 10px;"></i>
          <p><strong>Connection Issue</strong></p>
          <p>${getUserFriendlyErrorMessage(error)}</p>
          <p>Retrying... (${retryCount}/${RETRY_CONFIG.maxRetries})</p>
          <p style="font-size: 12px; color: #666;">Next attempt in ${delay/1000} seconds</p>
        </div>
      `;
      
      responseDetails.innerHTML = retryMessage;
      responseBox.className = 'response';
      responseBox.style.display = 'block';
    }

    function getUserFriendlyErrorMessage(error) {
      const errorMessage = error.message.toLowerCase();
      
      if (errorMessage.includes('failed to fetch') || errorMessage.includes('network error')) {
        return 'Unable to connect to the server. Please check your internet connection.';
      } else if (errorMessage.includes('timeout')) {
        return 'The server is taking too long to respond. The service might be experiencing high load.';
      } else if (errorMessage.includes('404')) {
        return 'The upload service is currently unavailable. Please try again later.';
      } else if (errorMessage.includes('500')) {
        return 'Server error occurred. Our team has been notified.';
      } else if (errorMessage.includes('413')) {
        return 'File is too large. Please ensure your PDF is under 10MB.';
      } else if (errorMessage.includes('429')) {
        return 'Too many requests. Please wait a moment and try again.';
      } else {
        return `An unexpected error occurred: ${error.message}`;
      }
    }

    function showSuccessResponse(data) {
      const hasStakeholderDetails = data.stakeholder_details && 
                                   data.stakeholder_details !== null && 
                                   data.stakeholder_details !== 'null';
      
      responseDetails.innerHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
          <i class="fas fa-check-circle" style="color: #34a853; font-size: 48px;"></i>
        </div>
        <p><strong>Filename:</strong> ${data.filename}</p>
        <p><strong>Upload Time:</strong> ${new Date(data.metadata.uploadtime).toLocaleString()}</p>
        <p><strong>Word Count:</strong> ${data.metadata.wordcount}</p>
        <p><strong>Status:</strong> <span style="color: #34a853;">${data.status}</span></p>
        <div class="preview-text">
          <strong>Preview:</strong><br>${data.preview}...
        </div>
        ${hasStakeholderDetails ? `
          <div class="preview-text" style="margin-top: 10px;">
            <strong>Stakeholder Details:</strong><br>
            ${typeof data.stakeholder_details === 'string' ?              
              `${data.stakeholder_details.length > 500 ? 
                  data.stakeholder_details.substring(0, 500) + '...' : 
                  data.stakeholder_details}` : 
              
              `${JSON.stringify(data.stakeholder_details, null, 2).length > 500 ? 
                  JSON.stringify(data.stakeholder_details, null, 2).substring(0, 500) + '...' : 
                  JSON.stringify(data.stakeholder_details, null, 2)}`}
          </div>
          <p><strong>Stakeholder Details Length:</strong> ${data.stakeholder_details_length}</p>
        ` : ''}
      `;
      
      responseBox.className = 'response success';
      responseBox.style.display = 'block';
      
      // Show download button with the actual API data
      showDownloadButton(data);
      
      // Reset for next upload (but keep download button visible)
      resetFileInputForNextUpload();
    }

    function showResponse(message, isSuccess) {
      const icon = isSuccess ? 'fa-check-circle' : 'fa-exclamation-triangle';
      const iconColor = isSuccess ? '#34a853' : '#ea4335';
      
      responseDetails.innerHTML = `
        <div style="text-align: center; margin-bottom: 15px;">
          <i class="fas ${icon}" style="color: ${iconColor}; font-size: 48px;"></i>
        </div>
        <p style="text-align: center;">${message}</p>
      `;
      responseBox.className = `response ${isSuccess ? 'success' : 'error'}`;
      responseBox.style.display = 'block';
      
      if (!isSuccess) {
        resetFileInput();
      }
    }

    function resetFileInput() {
      fileInput.value = '';
      fileInfo.style.display = 'none';
      uploadBtn.disabled = true;
      downloadBtn.style.display = 'none';
      currentFile = null;
    }

    function resetFileInputForNextUpload() {
      fileInput.value = '';
      fileInfo.style.display = 'none';
      uploadBtn.disabled = true;
      // Don't hide download button here - keep it available for the current result
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Enhanced PDF creation with proper page breaks and text positioning
    function downloadPDF(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Page dimensions
      const pageWidth = doc.internal.pageSize.width;
      const pageHeight = doc.internal.pageSize.height;
      const margin = 20;
      const lineHeight = 7;
      const maxWidth = pageWidth - (margin * 2);
      
      let yPosition = margin;
      
      // Function to add new page if needed
      const checkPageBreak = (requiredSpace = lineHeight) => {
        if (yPosition + requiredSpace > pageHeight - margin) {
          doc.addPage();
          yPosition = margin;
          return true;
        }
        return false;
      };
      
      // Add title
      doc.setFontSize(20);
      doc.setTextColor(66, 133, 244);
      doc.text('STAKEHOLDER ANALYSIS REPORT', margin, yPosition);
      yPosition += 25;
      
      // Add file info
      doc.setFontSize(12);
      doc.setTextColor(0, 0, 0);
      
      const fileInfo = [
        `Filename: ${data.filename}`,
        `Upload Time: ${new Date(data.metadata.uploadtime).toLocaleString()}`,
        `Word Count: ${data.metadata.wordcount}`,
        `Status: ${data.status}`
      ];
      
      fileInfo.forEach(info => {
        checkPageBreak();
        doc.text(info, margin, yPosition);
        yPosition += lineHeight + 2;
      });
      
      yPosition += 10;
      
      // Add content preview section
      checkPageBreak(15);
      doc.setFont(undefined, 'bold');
      doc.text('CONTENT PREVIEW:', margin, yPosition);
      yPosition += lineHeight + 5;
      
      // Use cleaned_text if available, otherwise use preview
      const content = data.cleaned_text || data.preview || 'No content available';
      doc.setFont(undefined, 'normal');
      
      const contentLines = doc.splitTextToSize(content, maxWidth);
      
      for (let i = 0; i < contentLines.length; i++) {
        checkPageBreak();
        doc.text(contentLines[i], margin, yPosition);
        yPosition += lineHeight;
        
        // Add some spacing after every 10 lines for readability
        if (i > 0 && i % 10 === 0) {
          yPosition += 5;
        }
      }
      
      yPosition += 10;
      
      // Add stakeholder details if available
      const hasStakeholderDetails = data.stakeholder_details && 
                                   data.stakeholder_details !== null && 
                                   data.stakeholder_details !== 'null';
      
      if (hasStakeholderDetails) {
        checkPageBreak(15);
        doc.setFont(undefined, 'bold');
        doc.text('STAKEHOLDER DETAILS:', margin, yPosition);
        yPosition += lineHeight + 5;
        
        doc.setFont(undefined, 'normal');
        const stakeholderText = typeof data.stakeholder_details === 'string' ? 
          data.stakeholder_details : 
          JSON.stringify(data.stakeholder_details, null, 2);
          
        const stakeholderLines = doc.splitTextToSize(stakeholderText, maxWidth);
        
        for (let i = 0; i < stakeholderLines.length; i++) {
          checkPageBreak();
          doc.text(stakeholderLines[i], margin, yPosition);
          yPosition += lineHeight;
        }
      }
      
      // Add footer on the last page
      const addFooter = () => {
        const footerY = pageHeight - 15;
        doc.setFontSize(10);
        doc.setTextColor(100, 100, 100);
        doc.text(`Report generated on: ${new Date().toLocaleString()}`, margin, footerY);
        doc.text('Stakeholder Identification System (SIS)', pageWidth - margin, footerY, { align: 'right' });
      };
      
      // Add footer to all pages
      const pageCount = doc.internal.getNumberOfPages();
      for (let i = 1; i <= pageCount; i++) {
        doc.setPage(i);
        addFooter();
      }
      
      // Save the PDF
      doc.save(`stakeholder_analysis_${data.filename.replace('.pdf', '')}.pdf`);
    }

    // Function to show download button in response
    function showDownloadButton(data) {
      downloadBtn.style.display = 'flex';
      
      // Update button click handler
      downloadBtn.onclick = () => {
        downloadPDF(data);
        
        // Add visual feedback
        const originalText = downloadBtn.innerHTML;
        downloadBtn.innerHTML = '<i class="fas fa-check"></i> Download Complete!';
        downloadBtn.style.background = 'linear-gradient(135deg, #34a853 0%, #0f9d58 100%)';
        
        // Reset button after 2 seconds
        setTimeout(() => {
          downloadBtn.innerHTML = originalText;
          downloadBtn.style.background = 'linear-gradient(135deg, #ea4335 0%, #fbbc05 100%)';
        }, 2000);
      };
    }
  });
</script>
</body>
</html>

